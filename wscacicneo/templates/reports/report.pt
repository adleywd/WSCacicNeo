<metal:main use-macro="load: ../basic/master.pt">
    <metal:content fill-slot="dash">
      Relatórios      
  </metal:content>
  <metal:content fill-slot="conteudo">
    <div class="matter">
        <div class="container">
            <div tal:condition="request.session.get('userid')">
                <div tal:condition="usuario_autenticado.orgao == request.matchdict['nm_orgao'] or usuario_autenticado.permissao == 'Administrador'">
                    <a type="button" href="#modal" data-toggle="modal" class="btn btn-sm btn-primary"><i class="fa fa-plus-square"></i> Adicionar valor</a>
                    <button type="button" id="error" class="btn btn-sm btn-warning"><i class="fa fa-exclamation-triangle"></i> Questionar coleta</button>
                    <button type="button" id="delete" class="btn btn-sm btn-success"><i class="fa fa-refresh"></i> Atualizar Relatório</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                <div class="widget" id="tabela_relatorio">
                        <div class="widget-head">
                            <div id="report-name" tal:condition="report_name == 'win32_processor'" class="pull-left">Relatório de Processadores</div>
                            <div id="report-name" tal:condition="report_name == 'win32_diskdrive'" class="pull-left">Relatório de HD</div>
                            <div id="report-name" tal:condition="report_name == 'win32_bios'" class="pull-left">Relatório da BIOS</div>
                            <div id="report-name" tal:condition="report_name == 'win32_physicalmemory'" class="pull-left">Relatório de Memória</div>
                            <div id="report-name" tal:condition="report_name == 'operatingsystem'" class="pull-left">Relatório de Sistemas Operacionais</div>
                            <div id="report-name" tal:condition="report_name == 'software'" class="pull-left">Relatório de Softwares (Suítes de Escritório)</div>
                            <form action="${request.route_url('json_csv')}" id="csv" method="POST">
                                <div class="widget-icons pull-right">
                                    <a href="#" id="print" title="Imprimir tabela"><i class="fa fa-print"></i></a>
                                    <a href="${request.route_url('root')}graficos/${request.matchdict['nm_orgao']}/${report_name}" id="grafico" title="Gerar gráfico"><i class="fa fa-bar-chart-o"></i></a>
                                    <a tal:condition="request.session.get('userid') and usuario_autenticado.orgao == request.matchdict['nm_orgao']" href="#" id="plus-home" title="Adicionar no início"><i class="fa fa-plus-circle"></i></a>
                                        <?python
                                              import json
                                              json_data = json.dumps(data)
                                              json_header = json.dumps(["Chave", "Valor"])
                                        ?>
                                        <input type="hidden" name="data" value="${json_data}">
                                        <input type="hidden" name="header" value="${json_header}">
                                        <a href="#" id="download-report" title="Baixar relatório" onclick="$('#csv').submit();"><i class="fa fa-download"></i></a>
                                    <a href="#help_buttons_report" title="Ajuda" data-toggle="modal"><i class="fa fa-question"></i></a>
                                </div>
                            </form>
                            <div class="clearfix"></div>
                        </div>
                        <div class="widget-content">
                            <div id="error-message" class="alert alert-danger" style="display:none">
                                Erro ao realizar a operação.
                            </div>
                            <div id="success-message" class="alert alert-success"  style="display:none">
                                Operação realizada com sucesso!
                            </div>
                            <div class="padd">
                                <div class="page-tables">
                                    <div class="table-responsive ">
                                        <table class="table table-condensed table-bordered table-hover no-margin" id="data-table">
                                            <thead>
                                                <tr class="info">
                                                    <th>Item</th>
                                                    <th width="10%">Quantidade</th>
                                                    <th width="5%">Opções</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="active" tal:repeat="k data.keys()">
                                                    <td>${k}</td>
                                                    <td width="10%">${data[k]}</td>
                                                    <tal tal:repeat="item_key index_itens.keys()">
                                                        <td width="5%" tal:condition="index_itens[item_key] == k" >
                                                            <a href="#modal_item_${item_key}" title="Ajuda" data-toggle="modal" class="btn btn-xs btn-warning">
                                                                <i class="fa fa-pencil"></i>
                                                            </a>
                                                        <!-- Modal De alteração do valor do Report -->
                                                        <div id="modal_item_${item_key}" class="modal fade" tabindex="-1"
                                                             role="dialog" aria-labelledby="myModalLabel"
                                                             aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close"
                                                                                data-dismiss="modal" aria-hidden="true">
                                                                            ×
                                                                        </button>
                                                                        <h4 class="modal-title">Alterar quantidade de "${index_itens[item_key]}"</h4>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <p>Valor atual: <b>${data[k]}</b></p>
                                                                        <div>
                                                                            <label class="control-label">Novo valor:</label>
                                                                            <input class="form-control" type="text" id="${item_key}" style="width:20%;" class="form-control" placeholder="Valor">
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" data-id="${item_key}" class="btn btn-primary">Alterar</button>
                                                                        <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td></tal>
                                                </tr>
                                                <div><b>Total de Computadores : ${count}</b></div>
                                            </tbody>
                                        </table>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog">
                            <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h4 class="modal-title">Adicionar Item</h4>
                            </div>
                            <form class="form-horizontal" role="form">
                                <div class="form-group" style="margin-top: 20px;">
                                    <label class="col-lg-2 control-label">Item:</label>
                                    <div class="col-lg-5">
                                        <input type="text" id="item" class="form-control" placeholder="item">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label">Quantidade:</label>
                                    <div class="col-lg-5">
                                        <input type="text" id="quant" class="form-control" placeholder="quantidade">
                                    </div>
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" id="enviar" class="btn btn-primary">Confirmar</button>
                                <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="box-chart">
        <canvas id="GraficoLine" style="width:100%;"></canvas>
    </div>
    </div>

  <!-- Modal Help Botões dos Reports -->
    <div id="help_buttons_report" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">Ajuda - Botões</h4>
                </div>
                <div class="modal-body">
                    <p><span class="fa fa-print"></span> - Imprime o relatório exibido.</p>
                    <p><span class="fa fa-bar-chart-o"></span> - Gera o gráfico do relatório exibido.</p>
                    <p tal:condition="request.session.get('userid') and usuario_autenticado.orgao == request.matchdict['nm_orgao']"><span class="fa fa-plus-circle"></span> - Adiciona o gráfico na página inicial.</p>
                    <p><span class="fa fa-download"></span> - Baixa o CSV do relatório</p>
                    <p style="font-style: italic; margin-left: 5%; color: #428BCA">Obs: O download pode demorar um pouco para iniciar.</p>
                    <!--?<p style="font-style: italic; margin-left: 5%; color: #428BCA">Obs: Você só poderá adicionar a sua página inicial os gráficos pertencetes ao seu órgão.</p>-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

  </metal:content>
    <metal:content fill-slot="javascript">
    <script type="text/javascript" src="${request.route_url('root')}static/jquery.print.js"></script>
    <script type="text/javascript">
        $(function() {
            $("#print").click(function() {
                $("#tabela_relatorio").print();
            });
            $('button').click(function(){
               data_id = $(this).attr('data-id')
               b = $(this).html()
                index_itens = ${index_itens}
               if(b == 'Alterar'){
                    value = $('#'+data_id).val()
                    attr = "${report_name}"
                    base = "${request.matchdict['nm_orgao']}"
                    data = {
                        'nm_base' : base,
                        'attr': attr,
                        'value' : value,
                        'item' : data_id,
                        'dict_itens': index_itens
                    }
            $.ajax({
                    type: "PUT",
                    url: "${request.route_url('root')}put_reports",
                    data: data,
                    success: function(){location.reload();   },
                    error: function(){ $('#error-message').show();}
                });

               }
            });
            $('#plus-home').click(function(){
                var data = {
                    report_name: "${report_name}"
                };
                $.ajax({
                    type: "POST",
                    url: "${request.route_url('add_user_home_report')}",
                    data: data,
                    success: function(){
                        $('#success-message').show();
                    },
                    error: function(){
                        $('#error-message').show();
                    }
                });
            });

            $('#enviar').click(function(){
                data = {
                    'item' : $('#item').val(),
                    'value' : $('#quant').val(),
                    'attr' : "${report_name}",
                    'base' : "${request.matchdict['nm_orgao']}",
                }
                $.ajax({
                    type: "PUT",
                    url: "${request.route_url('root')}post_reports",
                    data: data,
                    success: function(){location.reload();   },
                    error: function(){ $('#error-message').show();}
                });
            });
        });
        $('#delete').click(function(){
                base = {'base': "${request.matchdict['nm_orgao']}"}
                $.ajax({
                    type: "POST",
                    url: "${request.route_url('root')}delete_reports",
                    data : base,
                     success: function(){window.location .reload();},
                    error: function(){ $('#error-message').show();}
                });
            });
        $('#error').click(function(){
            window.location.href = "${request.route_url('notify')}";
        });
    </script>
</metal:content>
</metal:main>
